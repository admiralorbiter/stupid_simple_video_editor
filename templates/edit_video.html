<div class="container-fluid p-4">
    <h4>{{ video.title }}</h4>
    
    <!-- Video Player Section -->
    <div class="row mb-4">
        <div class="col">
            <video id="videoPlayer" 
                   class="w-100" 
                   controls
                   style="max-height: 70vh; background: #000;">
                <source src="{{ video.video_url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>
    </div>

    <!-- Segments Form -->
    <div class="segments-container mb-4">
        <h5>Segments to Remove</h5>
        <div id="segments-list" class="mb-3">
            <!-- Segments will be listed here -->
        </div>
        
        <!-- Segment Input Controls -->
        <div class="card">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-5">
                        <label class="form-label">Start Time</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="new-segment-start" placeholder="00:00">
                            <button type="button" class="btn btn-primary" onclick="setSegmentTime('start')">
                                Set Current
                            </button>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">End Time</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="new-segment-end" placeholder="00:00">
                            <button type="button" class="btn btn-primary" onclick="setSegmentTime('end')">
                                Set Current
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-success w-100" onclick="addSegment()">
                            Add Segment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Clip Form -->
        <form id="createClipForm" class="mt-3">
            <input type="hidden" name="video_id" value="{{ video.id }}">
            <input type="hidden" name="segments" id="segmentsData">
            
            <div class="mb-3">
                <label for="segments_clip_name" class="form-label">Clip Name</label>
                <input type="text" class="form-control" id="segments_clip_name" name="clip_name" required>
            </div>

            <button type="submit" class="btn btn-primary" id="createClipWithSegmentsBtn">
                <i class="bi bi-scissors me-2"></i>Create Clip with Segments
                <span class="segments-count"></span>
            </button>
        </form>
    </div>

    <!-- Clipping Controls -->
    <div class="card">
        <div class="card-body">
            <form id="clipForm" class="mb-3">
                <input type="hidden" name="video_id" value="{{ video.id }}">
                
                <!-- Time Controls -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="start_time" class="form-label">Start Time</label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="start_time" 
                                   name="start_time" 
                                   placeholder="00:00">
                            <button type="button" 
                                    class="btn btn-primary" 
                                    onclick="setCurrentTime('start_time')">
                                Set Current
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="end_time" class="form-label">End Time</label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="end_time" 
                                   name="end_time" 
                                   placeholder="00:00">
                            <button type="button" 
                                    class="btn btn-primary" 
                                    onclick="setCurrentTime('end_time')">
                                Set Current
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Clip Name -->
                <div class="mb-3">
                    <label for="clip_name" class="form-label">Clip Name</label>
                    <input type="text" 
                           class="form-control" 
                           id="clip_name" 
                           name="clip_name" 
                           required>
                </div>

                <!-- Create Clip Button -->
                <button type="submit" class="btn btn-success" id="createClipBtn">
                    <i class="bi bi-scissors me-2"></i>Create Clip
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// Initialize segments array
let segments = [];

function updateSegmentsList() {
    const segmentsList = document.getElementById('segments-list');
    segmentsList.innerHTML = '';
    
    segments.forEach((segment, index) => {
        const segmentDiv = document.createElement('div');
        segmentDiv.className = 'segment-item p-2 mb-2 rounded d-flex justify-content-between align-items-center';
        segmentDiv.innerHTML = `
            <span class="segment-time">
                <i class="bi bi-clock me-2"></i>
                ${segment.start} - ${segment.end}
            </span>
            <div class="btn-group">
                <button class="btn btn-outline-primary btn-sm" onclick="previewSegment(${index})">
                    <i class="bi bi-play-fill"></i> Preview
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="removeSegment(${index})">
                    <i class="bi bi-trash"></i> Remove
                </button>
            </div>
        `;
        segmentsList.appendChild(segmentDiv);
    });
    
    // Update create clip button state
    updateCreateClipWithSegmentsButton();
}

function removeSegment(index) {
    if (index >= 0 && index < segments.length) {
        segments.splice(index, 1); // Remove segment at index
        updateSegmentsList(); // Update the UI
        showAlert('Segment removed', 'success');
    }
}

function addSegment() {
    const startInput = document.getElementById('new-segment-start');
    const endInput = document.getElementById('new-segment-end');
    
    const start = startInput.value;
    const end = endInput.value;
    
    if (!start || !end) {
        showAlert('Please set both start and end times', 'warning');
        return;
    }
    
    segments.push({ start, end });
    updateSegmentsList();
    
    // Clear inputs
    startInput.value = '';
    endInput.value = '';
    
    showAlert('Segment added successfully', 'success');
}

function setSegmentTime(type) {
    const video = document.getElementById('videoPlayer');
    const currentTime = formatTime(video.currentTime);
    document.getElementById(`new-segment-${type}`).value = currentTime;
}

function formatTime(seconds) {
    const pad = (num) => String(num).padStart(2, '0');
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${pad(minutes)}:${pad(remainingSeconds)}`;
}

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.segments-container');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => alertDiv.remove(), 3000);
}

// Convert seconds to HH:MM:SS format
function formatTime(seconds) {
    const pad = (num) => String(num).padStart(2, '0');
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${pad(hours)}:${pad(minutes)}:${pad(secs)}`;
    }
    return `${pad(minutes)}:${pad(secs)}`;
}

// Set current video time to input field
function setCurrentTime(inputId) {
    const video = document.getElementById('videoPlayer');
    const input = document.getElementById(inputId);
    input.value = formatTime(video.currentTime);
}

// Preview the clip by setting video start/end times
function previewClip() {
    const video = document.getElementById('videoPlayer');
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    
    // Convert time format to seconds
    const startSeconds = timeToSeconds(startTime);
    const endSeconds = timeToSeconds(endTime);
    
    if (startSeconds !== null && endSeconds !== null) {
        video.currentTime = startSeconds;
        video.play();
        
        // Stop video at end time
        const checkEnd = setInterval(() => {
            if (video.currentTime >= endSeconds) {
                video.pause();
                clearInterval(checkEnd);
            }
        }, 100);
    }
}

// Convert HH:MM:SS or MM:SS to seconds
function timeToSeconds(timeStr) {
    const parts = timeStr.split(':').map(Number);
    if (parts.length === 3) {
        return parts[0] * 3600 + parts[1] * 60 + parts[2];
    } else if (parts.length === 2) {
        return parts[0] * 60 + parts[1];
    }
    return null;
}

// Reset video to beginning
function resetPreview() {
    const video = document.getElementById('videoPlayer');
    video.currentTime = 0;
    video.pause();
}

// Update current time display
document.getElementById('videoPlayer').addEventListener('timeupdate', function() {
    const currentTime = formatTime(this.currentTime);
    // Optional: Update a time display element
    // document.getElementById('currentTime').textContent = currentTime;
});

function previewSegment(index) {
    const segment = segments[index];
    const video = document.getElementById('videoPlayer');
    
    video.currentTime = segment.startSeconds;
    video.play();
    
    const checkEnd = setInterval(() => {
        if (video.currentTime >= segment.endSeconds) {
            video.pause();
            clearInterval(checkEnd);
        }
    }, 100);
}

// Handle segments form submission
document.getElementById('createClipForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (segments.length === 0) {
        showAlert('Please add at least one segment', 'warning');
        return;
    }
    
    document.getElementById('segmentsData').value = JSON.stringify(segments);
    
    try {
        const response = await fetch('{{ url_for("create_clip") }}', {
            method: 'POST',
            body: new FormData(this)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert('Clip created successfully!', 'success');
            
            // Reset form and segments
            this.reset();
            segments = [];
            updateSegmentsList();
            
            // Reload the page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert(result.message || 'Error creating clip', 'error');
        }
    } catch (error) {
        showAlert('Error creating clip', 'error');
        console.error(error);
    }
});

// Handle form submission for single clip
document.getElementById('clipForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    const clipName = document.getElementById('clip_name').value;
    
    if (!startTime || !endTime || !clipName) {
        showAlert('Please fill in all fields', 'error');
        return;
    }
    
    // Create a single segment from start and end times
    const segments = [{
        start: startTime,
        end: endTime
    }];
    
    const formData = new FormData(this);
    formData.set('segments', JSON.stringify(segments));
    
    try {
        const response = await fetch('{{ url_for("create_clip") }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert('Clip created successfully!', 'success');
            
            // Reset form
            this.reset();
            
            // Reload the page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert(result.message || 'Error creating clip', 'error');
        }
    } catch (error) {
        showAlert('Error creating clip', 'error');
        console.error(error);
    }
});

// Enable/disable create clip button based on form validity
function updateCreateClipWithSegmentsButton() {
    const clipName = document.getElementById('segments_clip_name').value;
    const createBtn = document.getElementById('createClipWithSegmentsBtn');
    createBtn.disabled = segments.length === 0 || !clipName;
}

// Add input event listener for clip name
document.getElementById('segments_clip_name').addEventListener('input', updateCreateClipWithSegmentsButton);
</script>

<style>
.segments-container {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.segment-item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.segment-item:hover {
    transform: translateX(4px);
    background: #fff;
    border-color: #adb5bd;
}

.segment-time {
    font-family: monospace;
    font-size: 1.1em;
    color: #495057;
}

.btn-group .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.btn-group .btn i {
    margin-right: 0.25rem;
}

.alert {
    transition: all 0.3s ease;
}
</style> 