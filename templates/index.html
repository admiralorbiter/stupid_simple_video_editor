{% extends "base.html" %}

{% block title %}Video Library{% endblock %}

{% block extra_css %}
<style>
    /* Sidebar styles */
    .sidebar {
        height: calc(100vh - 56px);
        width: 300px;
        position: fixed;
        left: 0;
        transition: 0.3s;
        background: var(--pale-dogwood);
        border-right: 1px solid var(--redwood);
        overflow-y: auto;
    }

    /* Folder selection area */
    .folder-selection {
        padding: 1.5rem;
        border-bottom: 1px solid var(--redwood);
        background: var(--dark-purple);
        color: var(--pale-dogwood);
    }

    /* Video list item styles */
    .video-list-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-bottom: 1px solid var(--redwood);
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .video-list-item:hover {
        background: var(--pale-dogwood);
        transform: translateX(5px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .video-list-item.selected {
        background: var(--dark-purple);
        color: var(--pale-dogwood);
        transform: translateX(5px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .video-list-item.selected small {
        color: rgba(255, 255, 255, 0.8);
    }

    /* Button styles */
    .btn-library {
        background-color: var(--redwood);
        color: var(--pale-dogwood);
        border: none;
        transition: background-color 0.3s ease;
    }

    .btn-library:hover {
        background-color: var(--eggplant);
        color: var(--pale-dogwood);
    }

    /* Collapsed states */
    .sidebar.collapsed {
        width: 0;
        overflow: hidden;
    }

    .main-content.expanded {
        margin-left: 0;
    }

    .sidebar-toggle.collapsed {
        left: 0;
    }

    /* Toggle button */
    .sidebar-toggle {
        position: fixed;
        left: 300px;
        top: 70px;
        transition: 0.3s;
        z-index: 1000;
        background: var(--dark-purple);
        color: var(--pale-dogwood);
        border: none;
        padding: 0.5rem;
        border-radius: 0 0.5rem 0.5rem 0;
        cursor: pointer;
    }

    .sidebar-toggle:hover {
        background: var(--eggplant);
    }

    /* Ensure content doesn't jump during transition */
    .sidebar, .main-content, .sidebar-toggle {
        transition: all 0.3s ease;
    }

    /* Main content area */
    .main-content {
        margin-left: 300px;
        transition: 0.3s;
        padding: 2rem;
        background: white;
    }

    /* Loading indicator */
    .htmx-indicator {
        display: none;
        color: var(--redwood);
    }
    
    .htmx-request .htmx-indicator {
        display: inline;
    }

    .video-thumbnail {
        width: 120px;
        height: 67.5px; /* 16:9 aspect ratio */
        margin-right: 1rem;
        background-color: var(--dark-purple);
        overflow: hidden;
        border-radius: 0.25rem;
    }

    .video-thumbnail-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .placeholder-thumbnail {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--pale-dogwood);
        font-size: 1.5rem;
    }

    .video-info {
        flex: 1;
    }

    .video-title {
        margin: 0;
        color: var(--raisin-black);
    }

    .video-duration {
        color: var(--redwood);
    }

    .btn-icon {
        background: none;
        border: none;
        color: var(--pale-dogwood);
        padding: 0.5rem;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }

    .btn-icon:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
    }

    .btn-icon.active {
        background-color: var(--redwood);
        color: white;
    }

    .delete-controls {
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--dark-purple);
    }

    .library-header {
        position: sticky;
        top: 0;
        z-index: 1000;
        background-color: var(--dark-purple);
    }

    .header-actions {
        display: flex;
        gap: 0.5rem;
    }

    .library-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--pale-dogwood);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0;
        padding: 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Sidebar Toggle Button -->
<button class="sidebar-toggle btn btn-sm" onclick="toggleSidebar()">
    <i class="bi bi-chevron-left" id="toggle-icon"></i>
</button>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <!-- Video Library Header -->
    <div class="library-header">
        <div class="d-flex justify-content-between align-items-center p-3">
            <h6 class="mb-0 library-title">Video Library</h6>
            <div class="header-actions">
                <!-- Add folder/tag dropdown -->
                <div class="dropdown">
                    <button class="btn btn-icon" data-bs-toggle="dropdown">
                        <i class="bi bi-folder"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><h6 class="dropdown-header">Folders</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="createFolder()">Create Folder</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Tags</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="manageVideoTags()">Manage Tags</a></li>
                    </ul>
                </div>
                <!-- Existing delete button -->
                <button class="btn btn-icon" id="delete-mode-btn" onclick="toggleDeleteMode()">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        
        <!-- Delete Controls (initially hidden) -->
        <div id="delete-controls" class="delete-controls" style="display: none;">
            <div class="d-flex justify-content-between p-3 bg-danger">
                <button class="btn btn-sm btn-light" onclick="cancelDelete()">
                    <i class="bi bi-x-lg"></i>
                </button>
                <button class="btn btn-sm btn-danger" id="confirm-delete-btn" onclick="confirmDelete()" disabled>
                    <i class="bi bi-trash"></i> <span class="delete-count">0</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Folder Selection -->
    <div class="folder-selection">
        <form hx-post="/select-folder" 
              hx-target="#video-list"
              hx-indicator="#loading-indicator">
            <div class="d-flex gap-2 flex-column">
                <button type="button" 
                        class="btn btn-library" 
                        id="browse-button">
                    <i class="bi bi-folder2-open me-2"></i>Browse Folder
                </button>
                <button type="submit" 
                        class="btn btn-library" 
                        id="scan-button" 
                        style="display: none;">
                    <i class="bi bi-search me-2"></i>Scan Folder
                </button>
                <button type="button" 
                        class="btn btn-library" 
                        id="clipsFolder">
                    <i class="bi bi-folder2-open me-2"></i>Set Clips Folder
                </button>
                <div id="loading-indicator" class="htmx-indicator">
                    <div class="spinner-border spinner-border-sm"></div>
                    Scanning...
                </div>
            </div>
            <div id="selected-folder" class="clips-will-save mt-2">
                <span class="folder-label">Selected Folder:</span>
                <div class="folder-path"></div>
            </div>
            <div id="selected-clips-folder" class="clips-will-save mt-2">
                <span class="folder-label">Clips will be saved to:</span>
                <div class="folder-path"></div>
            </div>
        </form>
    </div>

    <!-- Video List -->
    <div id="video-list">
        {% include 'video_list.html' %}
    </div>
</div>

<!-- Main Content -->
<div class="main-content" id="main-content">
    <div id="editor-content">
        <!-- Initial state or selected video editor will be loaded here -->
        <div class="text-center text-muted">
            <p>Select a video from the list to edit</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('main-content');
    const toggleBtn = document.querySelector('.sidebar-toggle');
    const toggleIcon = document.getElementById('toggle-icon');
    
    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('expanded');
    toggleBtn.classList.toggle('collapsed');
    
    if (sidebar.classList.contains('collapsed')) {
        toggleIcon.classList.replace('bi-chevron-left', 'bi-chevron-right');
    } else {
        toggleIcon.classList.replace('bi-chevron-right', 'bi-chevron-left');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const browseButton = document.getElementById('browse-button');
    const scanButton = document.getElementById('scan-button');
    const selectedFolder = document.getElementById('selected-folder');

    browseButton.addEventListener('click', async function(e) {
        e.preventDefault();
        try {
            const response = await fetch('/browse-folder');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            
            if (data.status === 'success') {
                selectedFolder.querySelector('.folder-path').textContent = data.folder;
                selectedFolder.style.display = 'block';
                scanButton.style.display = 'block';
            } else if (data.status === 'error') {
                console.error('Server error:', data.message);
            }
        } catch (error) {
            console.error('Error selecting folder:', error);
        }
    });
});

document.getElementById('clipsFolder').addEventListener('click', async function(e) {
    e.preventDefault();
    try {
        const response = await fetch('/select-clips-folder');
        const data = await response.json();
        
        if (data.status === 'success') {
            const clipsFolderDiv = document.getElementById('selected-clips-folder');
            clipsFolderDiv.querySelector('.folder-path').textContent = data.folder;
            clipsFolderDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Error selecting clips folder:', error);
    }
});

function toggleDeleteMode() {
    const deleteBtn = document.getElementById('delete-mode-btn');
    const deleteControls = document.getElementById('delete-controls');
    const isActive = deleteBtn.classList.toggle('active');
    
    if (isActive) {
        deleteControls.classList.remove('hide');
        deleteControls.classList.add('show');
        deleteControls.style.display = 'block';
    } else {
        deleteControls.classList.remove('show');
        deleteControls.classList.add('hide');
        setTimeout(() => {
            deleteControls.style.display = 'none';
        }, 300);
    }
    
    window.toggleSelectionMode(isActive);
}

function cancelDelete() {
    toggleDeleteMode();
}

function confirmDelete() {
    const selectedVideos = document.querySelectorAll('.video-list-item.selected');
    const videoIds = Array.from(selectedVideos).map(el => el.dataset.videoId);
    
    fetch('/delete-videos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ video_ids: videoIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            selectedVideos.forEach(video => {
                video.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => video.remove(), 300);
            });
            toggleDeleteMode();
        }
    })
    .catch(error => console.error('Error:', error));
}

// Add this to your existing styles
document.head.insertAdjacentHTML('beforeend', `
    <style>
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }
    </style>
`);
</script>
{% endblock %}